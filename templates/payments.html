<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase {{ package.name }} - Free Fire Diamonds</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>Free Fire Diamonds</h2>
            </div>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('packages') }}" class="nav-link">Packages</a>
                <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="payment-page">
            <h1 class="page-title">Purchase {{ package.name }}</h1>
            
            <div class="payment-container">
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-card">
                        <div class="package-info">
                            <h4>{{ package.name }}</h4>
                            <p class="diamonds">{{ package.diamonds }} Diamonds</p>
                        </div>
                        
                        <div class="price-summary">
                            <div class="price-row">
                                <span>USD Price:</span>
                                <span>${{ "%.2f"|format(package.price) }}</span>
                            </div>
                            <div class="price-row">
                                <span>Naira Price:</span>
                                <span class="naira-price">{{ usd_to_ngn(package.price) }}</span>
                            </div>
                            {% if package.discount > 0 %}
                            <div class="price-row discount">
                                <span>Discount:</span>
                                <span>{{ package.discount }}% OFF</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="payment-methods">
                    <h3>Payment Method</h3>
                    
                    <!-- Saved Payment Methods -->
                    {% if payment_methods %}
                    <div class="saved-methods">
                        <h4>Saved Payment Methods</h4>
                        {% for method in payment_methods %}
                        <div class="payment-method-card">
                            <input type="radio" name="payment_method" value="{{ method.id }}" id="method_{{ method.id }}" {% if method.is_default %}checked{% endif %}>
                            <label for="method_{{ method.id }}">
                                <span class="card-type">{{ method.card_type }}</span>
                                <span class="card-number">**** **** **** {{ method.last_four }}</span>
                                <span class="expiry">{{ method.expiry_month }}/{{ method.expiry_year }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- New Card Form -->
                    <div class="new-card-form">
                        <h4>Add New Card</h4>
                        <form id="payment-form">
                            <div class="form-group">
                                <label class="form-label">Card Holder Name</label>
                                <input type="text" class="form-control" name="card_holder_name" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Expiry Month</label>
                                    <select class="form-control" name="expiry_month" required>
                                        <option value="">Month</option>
                                        {% for month in range(1, 13) %}
                                        <option value="{{ month }}">{{ month }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Expiry Year</label>
                                    <select class="form-control" name="expiry_year" required>
                                        <option value="">Year</option>
                                        {% for year in range(2024, 2035) %}
                                        <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">CVV</label>
                                    <input type="text" class="form-control" name="cvv" placeholder="123" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="save_card" checked>
                                    Save this card for future purchases
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">Complete Purchase</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Free Fire Diamonds. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.getElementById('payment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                package_id: {{ package.id }},
                card_holder_name: formData.get('card_holder_name'),
                card_number: formData.get('card_number'),
                expiry_month: parseInt(formData.get('expiry_month')),
                expiry_year: parseInt(formData.get('expiry_year')),
                cvv: formData.get('cvv'),
                save_card: formData.get('save_card') === 'on'
            };
            
            fetch('/api/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.href = '/dashboard';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error processing payment: ' + error);
            });
        });
    </script>
</body>
</html>
