<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase {{ package.name }} - Free Fire Diamonds</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .payment-required {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .payment-required h3 {
            color: #856404;
            margin-bottom: 1rem;
        }
        
        .payment-required p {
            color: #856404;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>Free Fire Diamonds</h2>
            </div>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('packages') }}" class="nav-link">Packages</a>
                <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="payment-page">
            <h1 class="page-title">Purchase {{ package.name }}</h1>
            
            <!-- Payment Required Warning -->
            {% if not payment_methods %}
            <div class="payment-required">
                <h3>⚠️ Payment Method Required</h3>
                <p>You need to add a payment method before you can purchase diamonds.</p>
                <a href="{{ url_for('payment_methods') }}" class="btn btn-primary">Add Payment Method</a>
            </div>
            {% endif %}
            
            <div class="payment-container">
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-card">
                        <div class="package-info">
                            <h4>{{ package.name }}</h4>
                            <p class="diamonds">{{ package.diamonds }} Diamonds</p>
                        </div>
                        
                        <div class="price-summary">
                            <div class="price-row">
                                <span>USD Price:</span>
                                <span>${{ "%.2f"|format(package.price) }}</span>
                            </div>
                            <div class="price-row">
                                <span>Naira Price:</span>
                                <span class="naira-price">{{ usd_to_ngn(package.price) }}</span>
                            </div>
                            {% if package.discount > 0 %}
                            <div class="price-row discount">
                                <span>Discount:</span>
                                <span>{{ package.discount }}% OFF</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if payment_methods %}
                <div class="payment-methods">
                    <h3>Payment Method</h3>
                    
                    <!-- Saved Payment Methods -->
                    <div class="saved-methods">
                        <h4>Saved Payment Methods</h4>
                        {% for method in payment_methods %}
                        <div class="payment-method-card">
                            <input type="radio" name="payment_method" value="{{ method.id }}" id="method_{{ method.id }}" {% if method.is_default %}checked{% endif %}>
                            <label for="method_{{ method.id }}">
                                <span class="card-type">{{ method.card_type }}</span>
                                <span class="card-number">**** **** **** {{ method.last_four }}</span>
                                <span class="expiry">{{ method.expiry_month }}/{{ method.expiry_year }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Or Use New Card -->
                    <div class="new-card-form">
                        <h4>Or Use New Card</h4>
                        <form id="payment-form">
                            <input type="hidden" name="package_id" value="{{ package.id }}">
                            
                            <div class="form-group">
                                <label class="form-label">Card Holder Name</label>
                                <input type="text" class="form-control" name="card_holder_name" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Expiry Month</label>
                                    <select class="form-control" name="expiry_month" required>
                                        <option value="">Month</option>
                                        {% for month in range(1, 13) %}
                                        <option value="{{ month }}">{{ "%02d"|format(month) }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Expiry Year</label>
                                    <select class="form-control" name="expiry_year" required>
                                        <option value="">Year</option>
                                        {% for year in range(2024, 2035) %}
                                        <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">CVV</label>
                                    <input type="text" class="form-control" name="cvv" placeholder="123" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="save_card" checked>
                                    Save this card for future purchases
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">Complete Purchase</button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Free Fire Diamonds. All rights reserved.</p>
        </div>
    </footer>

    {% if payment_methods %}
    <script>
        document.getElementById('payment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const useSavedCard = document.querySelector('input[name="payment_method"]:checked');
            
            let paymentData = {
                package_id: {{ package.id }},
                use_saved_card: false,
                card_data: {}
            };
            
            if (useSavedCard && !formData.get('card_number')) {
                // Use saved card
                paymentData.use_saved_card = true;
                paymentData.payment_method_id = parseInt(useSavedCard.value);
                paymentData.card_data = {};
            } else {
                // Use new card
                paymentData.use_saved_card = false;
                paymentData.payment_method_id = null;
                paymentData.card_data = {
                    card_holder_name: formData.get('card_holder_name'),
                    card_number: formData.get('card_number'),
                    expiry_month: parseInt(formData.get('expiry_month')),
                    expiry_year: parseInt(formData.get('expiry_year')),
                    cvv: formData.get('cvv')
                };
            }
            
            fetch('/api/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(paymentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.href = '/dashboard';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error processing payment: ' + error);
            });
        });

        // Format card number input
        document.querySelector('input[name="card_number"]').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ');
            if (formattedValue) {
                e.target.value = formattedValue;
            }
        });

        // When user selects a saved card, clear the new card form
        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    document.querySelector('input[name="card_number"]').value = '';
                    document.querySelector('input[name="card_holder_name"]').value = '';
                    document.querySelector('select[name="expiry_month"]').value = '';
                    document.querySelector('select[name="expiry_year"]').value = '';
                    document.querySelector('input[name="cvv"]').value = '';
                }
            });
        });

        // When user starts typing in new card form, deselect saved cards
        document.querySelectorAll('#payment-form input, #payment-form select').forEach(input => {
            input.addEventListener('input', function() {
                document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
                    radio.checked = false;
                });
            });
        });
    </script>
    {% endif %}
</body>
</html>
